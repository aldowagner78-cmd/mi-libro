<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>El Silencio de los Dioses - Lector</title>
    
    <!-- Preload de imagen cr√≠tica -->
    <link rel="preload" href="imagenes/cover_opt.png" as="image">
    
    <!-- Preload miniaturas visibles -->
    <link rel="preload" href="imagenes/cap_01.png" as="image">
    <link rel="preload" href="imagenes/cap_02.png" as="image">
    <link rel="preload" href="imagenes/cap_03.png" as="image">
    <link rel="preload" href="imagenes/cap_04.png" as="image">
    <link rel="preload" href="imagenes/cap_05.png" as="image">
    
    <!-- Fuentes -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,600;1,400&family=Nunito:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Se usan archivos HTML pregenerados -->

    <style>
        :root {
            --bg: #ffffff;
            --bg-alt: #f7f7f8;
            --text: #1f2937;
            --text-soft: #6b7280;
            --accent: #7c3aed;
            --accent-soft: rgba(124, 58, 237, 0.1);
            --border: #e5e7eb;
            --shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            --radius: 16px;
            --sidebar: 300px;
            --font-body: 'Lora', Georgia, serif;
            --font-ui: 'Nunito', system-ui, sans-serif;
        }
        
        /* TEMAS */
        [data-theme="cream"] {
            --bg: #fef9f3;
            --bg-alt: #fdf6ed;
            --text: #44403c;
            --text-soft: #78716c;
            --accent: #c2410c;
            --accent-soft: rgba(194, 65, 12, 0.1);
            --border: #e7e5e4;
        }
        [data-theme="mint"] {
            --bg: #f0fdf4;
            --bg-alt: #ecfdf5;
            --text: #14532d;
            --text-soft: #166534;
            --accent: #16a34a;
            --accent-soft: rgba(22, 163, 74, 0.1);
            --border: #bbf7d0;
        }
        [data-theme="ocean"] {
            --bg: #f0f9ff;
            --bg-alt: #e0f2fe;
            --text: #0c4a6e;
            --text-soft: #0369a1;
            --accent: #0284c7;
            --accent-soft: rgba(2, 132, 199, 0.1);
            --border: #bae6fd;
        }
        [data-theme="lavender"] {
            --bg: #faf5ff;
            --bg-alt: #f3e8ff;
            --text: #581c87;
            --text-soft: #7c3aed;
            --accent: #9333ea;
            --accent-soft: rgba(147, 51, 234, 0.1);
            --border: #e9d5ff;
        }
        [data-theme="sepia"] {
            --bg: #f5f0e6;
            --bg-alt: #ebe5d9;
            --text: #3d3225;
            --text-soft: #6b5c4a;
            --accent: #a67c52;
            --accent-soft: rgba(166, 124, 82, 0.12);
            --border: #d4c9b8;
        }
        [data-theme="dark"] {
            --bg: #111827;
            --bg-alt: #1f2937;
            --text: #f3f4f6;
            --text-soft: #9ca3af;
            --accent: #a78bfa;
            --accent-soft: rgba(167, 139, 250, 0.15);
            --border: #374151;
        }
        [data-theme="midnight"] {
            --bg: #020617;
            --bg-alt: #0f172a;
            --text: #e2e8f0;
            --text-soft: #94a3b8;
            --accent: #38bdf8;
            --accent-soft: rgba(56, 189, 248, 0.12);
            --border: #1e293b;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: var(--font-ui);
            background: var(--bg);
            color: var(--text);
            display: flex;
            height: 100vh;
            overflow: hidden;
            transition: background 0.3s, color 0.3s;
        }

        /* ===================== SIDEBAR ===================== */
        #sidebar {
            width: var(--sidebar);
            background: var(--bg-alt);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            height: 100%;
            position: fixed;
            left: calc(-1 * var(--sidebar));
            z-index: 100;
            transition: left 0.3s ease;
        }
        #sidebar.open { left: 0; }
        @media(min-width: 900px) {
            #sidebar { position: relative; left: 0 !important; }
        }

        .sidebar-head {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 12px;
            flex-direction: column;
        }
        
        .book-cover {
            width: 100%;
            max-width: 200px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            margin-bottom: 12px;
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .book-cover:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.25);
        }
        
        .sidebar-title {
            display: flex;
            align-items: center;
            gap: 12px;
            width: 100%;
        }
        
        .sidebar-head svg { color: var(--accent); flex-shrink: 0; }
        .sidebar-head h1 { font-size: 1rem; font-weight: 700; line-height: 1.3; }
        
        .chapter-list {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            list-style: none;
        }
        
        .chapter-list-divider {
            padding: 16px 12px 8px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-soft);
            opacity: 0.7;
        }
        
        .special-section {
            color: var(--accent) !important;
            font-style: italic;
        }
        .special-section svg {
            color: var(--accent) !important;
        }
        
        .chapter-list-divider {
            padding: 16px 12px 8px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-soft);
            opacity: 0.7;
        }
        
        .special-section {
            color: var(--accent) !important;
            font-style: italic;
        }
        .special-section svg {
            color: var(--accent) !important;
        }
        .chapter-list::-webkit-scrollbar { width: 5px; }
        .chapter-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
        
        .chapter-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 14px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.9rem;
            color: var(--text-soft);
            transition: all 0.2s;
            margin-bottom: 4px;
            position: relative;
        }
        .chapter-item:hover { background: var(--accent-soft); color: var(--accent); }
        .chapter-item.active { background: var(--accent); color: #fff; font-weight: 600; }
        .chapter-item.read { opacity: 0.6; }
        .chapter-item.read::after {
            content: '‚úì';
            position: absolute;
            right: 12px;
            color: var(--accent);
            font-weight: bold;
        }
        .chapter-item.reading {
            border-left: 3px solid var(--accent);
            padding-left: 11px;
        }
        .chapter-item.bookmarked::before {
            content: 'üîñ';
            position: absolute;
            right: 32px;
            font-size: 12px;
        }
        .chapter-item svg { width: 16px; height: 16px; }
        
        .chapter-thumbnail {
            width: 36px;
            height: 36px;
            border-radius: 6px;
            object-fit: cover;
            flex-shrink: 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .chapter-item.active .chapter-thumbnail {
            box-shadow: 0 0 0 2px #fff;
        }

        /* ===================== MAIN ===================== */
        #main {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }

        /* Toolbar */
        .toolbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 20px;
            border-bottom: 1px solid var(--border);
            background: var(--bg);
            gap: 12px;
            flex-wrap: wrap;
        }
        .toolbar-left, .toolbar-right { display: flex; align-items: center; gap: 8px; }
        
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 8px 12px;
            border: 1px solid var(--border);
            background: var(--bg);
            color: var(--text-soft);
            border-radius: 10px;
            cursor: pointer;
            font-family: var(--font-ui);
            font-size: 0.85rem;
            transition: all 0.2s;
        }
        .btn:hover { background: var(--accent-soft); color: var(--accent); border-color: var(--accent); }
        .btn svg { width: 18px; height: 18px; }
        .btn.icon { padding: 8px; }
        
        .btn-menu { display: flex; }
        @media(min-width: 900px) { .btn-menu { display: none; } }

        .chapter-title {
            font-weight: 600;
            font-size: 0.95rem;
            color: var(--text);
        }

        /* Selector de temas */
        .theme-picker {
            display: flex;
            gap: 4px;
            padding: 4px;
            background: var(--bg-alt);
            border-radius: 20px;
        }
        .theme-dot {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid transparent;
            cursor: pointer;
            transition: transform 0.2s, border-color 0.2s;
        }
        .theme-dot:hover { transform: scale(1.1); }
        .theme-dot.active { border-color: var(--accent); transform: scale(1.15); }
        
        .theme-dot[data-theme="light"] { background: linear-gradient(135deg, #fff, #f3f4f6); }
        .theme-dot[data-theme="cream"] { background: linear-gradient(135deg, #fef9f3, #fde68a); }
        .theme-dot[data-theme="mint"] { background: linear-gradient(135deg, #d1fae5, #6ee7b7); }
        .theme-dot[data-theme="ocean"] { background: linear-gradient(135deg, #e0f2fe, #7dd3fc); }
        .theme-dot[data-theme="lavender"] { background: linear-gradient(135deg, #f3e8ff, #c4b5fd); }
        .theme-dot[data-theme="sepia"] { background: linear-gradient(135deg, #f5f0e6, #d4a574); }
        .theme-dot[data-theme="dark"] { background: linear-gradient(135deg, #374151, #111827); }
        .theme-dot[data-theme="midnight"] { background: linear-gradient(135deg, #1e293b, #020617); }

        /* ===================== READER ===================== */
        #reader {
            flex: 1;
            overflow-y: auto;
            padding: 50px 24px 120px;
            scroll-behavior: smooth;
        }
        #reader::-webkit-scrollbar { width: 8px; }
        #reader::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

        /* ===================== COVER SCREEN ===================== */
        .cover-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg);
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            z-index: 1000;
            animation: fadeIn 0.4s ease;
            overflow-y: auto;
        }
        .cover-screen.show { display: flex; }
        
        /* Portada Principal */
        .main-cover-screen {
            padding: 40px 20px;
        }
        .main-cover-screen .cover-image-container {
            max-width: 500px;
            max-height: 80vh;
        }
        .main-cover-screen .cover-book-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
        }
        .main-cover-screen .cover-author {
            font-size: 18px;
            color: var(--text-soft);
            margin-bottom: 40px;
        }
        .enter-book-btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 18px 56px;
            font-size: 20px;
            font-weight: 700;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }
        .enter-book-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }
        
        /* Secciones especiales del libro */
        .book-section {
            background: var(--bg);
            border-radius: 12px;
            padding: 40px;
            max-width: 800px;
            margin: 0 auto;
            text-align: left;
        }
        .book-section h2 {
            font-size: 28px;
            font-weight: 700;
            color: var(--accent);
            margin-bottom: 24px;
            text-align: center;
        }
        .book-section p {
            font-size: 18px;
            line-height: 1.8;
            color: var(--text);
            margin-bottom: 16px;
        }
        .book-section .signature {
            text-align: right;
            font-style: italic;
            color: var(--text-soft);
            margin-top: 32px;
        }
        .section-divider {
            width: 60px;
            height: 3px;
            background: var(--accent);
            margin: 32px auto;
        }
        
        .cover-image-container {
            max-width: 600px;
            max-height: 70vh;
            margin-bottom: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            border-radius: 12px;
            overflow: hidden;
        }
        .cover-image-full {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        .cover-chapter-title {
            font-size: 32px;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 12px;
            text-align: center;
        }
        .cover-book-title {
            font-size: 20px;
            color: var(--text-muted);
            margin-bottom: 40px;
            text-align: center;
        }
        .start-reading-btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 16px 48px;
            font-size: 18px;
            font-weight: 600;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .start-reading-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        .start-reading-btn:active {
            transform: translateY(0);
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* ===================== AUDIO PLAYER ===================== */
        .audio-player {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-alt);
            border-top: 1px solid var(--border);
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 16px;
            z-index: 50;
            box-shadow: 0 -4px 12px rgba(0,0,0,0.05);
            transform: translateY(100%);
            transition: transform 0.3s ease;
        }
        
        .audio-player.show {
            transform: translateY(0);
        }
        
        .audio-player.minimized {
            padding: 8px 20px;
        }
        
        .audio-info {
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 0;
            flex: 1;
        }
        
        .audio-cover {
            width: 48px;
            height: 48px;
            border-radius: 8px;
            object-fit: cover;
            flex-shrink: 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        
        .audio-player.minimized .audio-cover {
            width: 36px;
            height: 36px;
        }
        
        .audio-details {
            min-width: 0;
            flex: 1;
        }
        
        .audio-title {
            font-family: var(--font-ui);
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--text);
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .audio-subtitle {
            font-family: var(--font-ui);
            font-size: 0.75rem;
            color: var(--text-soft);
        }
        
        .audio-controls {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .audio-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background: var(--accent);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        
        .audio-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(124, 58, 237, 0.3);
        }
        
        .audio-btn.secondary {
            width: 32px;
            height: 32px;
            background: var(--bg);
            color: var(--text-soft);
            border: 1px solid var(--border);
        }
        
        .audio-btn.secondary:hover {
            background: var(--accent-soft);
            color: var(--accent);
            border-color: var(--accent);
        }
        
        .audio-progress-container {
            flex: 1;
            min-width: 200px;
        }
        
        .audio-times {
            display: flex;
            justify-content: space-between;
            font-family: var(--font-ui);
            font-size: 0.7rem;
            color: var(--text-soft);
            margin-bottom: 6px;
        }
        
        .audio-progress {
            width: 100%;
            height: 6px;
            background: var(--border);
            border-radius: 3px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .audio-progress-bar {
            height: 100%;
            background: var(--accent);
            border-radius: 3px;
            transition: width 0.1s linear;
            position: relative;
        }
        
        .audio-progress-bar::after {
            content: '';
            position: absolute;
            right: -6px;
            top: 50%;
            transform: translateY(-50%);
            width: 12px;
            height: 12px;
            background: var(--accent);
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .audio-volume {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .audio-speed {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .speed-value {
            font-family: var(--font-ui);
            font-size: 13px;
            font-weight: 600;
            color: var(--text-soft);
            min-width: 40px;
            text-align: center;
        }
        
        .volume-slider, .speed-slider {
            width: 80px;
            height: 4px;
            -webkit-appearance: none;
            appearance: none;
            background: var(--border);
            border-radius: 2px;
            outline: none;
        }
        
        .volume-slider::-webkit-slider-thumb, .speed-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 12px;
            height: 12px;
            background: var(--accent);
            border-radius: 50%;
            cursor: pointer;
        }
        
        .volume-slider::-moz-range-thumb, .speed-slider::-moz-range-thumb {
            width: 12px;
            height: 12px;
            background: var(--accent);
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }
        
        .audio-close {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 1px solid var(--border);
            background: var(--bg);
            color: var(--text-soft);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        
        .audio-close:hover {
            background: #fee;
            color: #e11d48;
            border-color: #e11d48;
        }
        
        /* ===================== BOOKMARKS & PROGRESS ===================== */
        .bookmark-btn {
            background: var(--bg-alt);
            border: 1px solid var(--border);
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }
        .bookmark-btn:hover {
            background: var(--accent-soft);
            border-color: var(--accent);
        }
        .bookmark-btn.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }
        .bookmark-btn.active svg {
            fill: white;
        }
        .progress-bar-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--border);
            z-index: 9999;
        }
        .progress-bar {
            height: 100%;
            background: var(--accent);
            transition: width 0.3s ease;
            width: 0%;
        }
        
        @media(max-width: 768px) {
            .audio-player {
                flex-wrap: wrap;
                padding: 12px 16px;
                gap: 12px;
            }
            .audio-volume {
                display: none;
            }
            .audio-speed {
                display: flex;
                order: 3;
                margin-left: auto;
            }
            .audio-info {
                order: 1;
                width: 100%;
                margin-bottom: 8px;
            }
            .audio-controls {
                order: 2;
            }
            .audio-progress-container {
                order: 0;
                width: 100%;
                margin-bottom: 8px;
            }
            .speed-slider {
                width: 60px;
            }
        }

        #content {
            max-width: 700px;
            margin: 0 auto;
            font-family: var(--font-body);
            font-size: 1.15rem;
            line-height: 1.9;
            color: var(--text);
        }
        
        #content p { margin-bottom: 1.5em; text-align: justify; }
        #content strong { font-weight: 600; }
        #content em { font-style: italic; }
        #content h1, #content h2, #content h3 {
            font-family: var(--font-ui);
            text-align: center;
            margin: 2em 0 1em;
            font-weight: 700;
        }
        #content h1 { font-size: 1.6em; }
        #content h2 { font-size: 1.3em; color: var(--text-soft); }

        /* Notas al pie */
        #content sup {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: var(--accent);
            color: #fff !important;
            text-decoration: none;
            font-family: var(--font-ui);
            font-size: 0.65em;
            font-weight: 700;
            min-width: 20px;
            height: 20px;
            padding: 0 6px;
            border-radius: 10px;
            cursor: pointer;
            vertical-align: baseline;
            margin: 0 2px;
            transition: transform 0.2s, background 0.2s;
        }
        #content sup:hover {
            transform: scale(1.15);
            background: var(--text);
        }
        #content sup a {
            color: #fff !important;
            text-decoration: none !important;
        }
        
        /* Ocultar lista de notas al final */
        #content ol { display: none !important; }

        /* Navegaci√≥n */
        .nav-chapter {
            display: flex;
            justify-content: space-between;
            gap: 16px;
            margin-top: 60px;
            padding-top: 30px;
            border-top: 1px solid var(--border);
        }
        .nav-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 14px 20px;
            background: var(--bg-alt);
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--text-soft);
            font-family: var(--font-ui);
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        .nav-btn:hover:not(:disabled) { background: var(--accent); color: #fff; border-color: var(--accent); }
        .nav-btn:disabled { opacity: 0.4; cursor: not-allowed; }
        .nav-btn svg { width: 18px; height: 18px; }

        /* Loading */
        #loading {
            display: none;
            position: absolute;
            inset: 0;
            background: var(--bg);
            z-index: 50;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            gap: 16px;
        }
        #loading.show { display: flex; }
        .spinner {
            width: 36px;
            height: 36px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* ===================== POPUP NOTAS ===================== */
        #overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            opacity: 0;
            visibility: hidden;
            z-index: 200;
            transition: opacity 0.3s;
        }
        #overlay.show { opacity: 1; visibility: visible; }

        #note-popup {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%) translateY(100%);
            width: min(600px, calc(100% - 32px));
            background: var(--bg);
            border-radius: 20px 20px 0 0;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.2);
            z-index: 210;
            transition: transform 0.35s cubic-bezier(0.32, 0.72, 0, 1);
            overflow: hidden;
        }
        #note-popup.show { transform: translateX(-50%) translateY(0); }

        .note-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            background: var(--bg-alt);
        }
        .note-header span {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            color: var(--accent);
        }
        .note-header span svg { width: 20px; height: 20px; }
        .note-close {
            background: none;
            border: none;
            color: var(--text-soft);
            cursor: pointer;
            padding: 6px;
            border-radius: 8px;
            transition: background 0.2s;
        }
        .note-close:hover { background: var(--accent-soft); }
        .note-close svg { width: 20px; height: 20px; }

        .note-body {
            padding: 20px;
            font-family: var(--font-ui);
            font-size: 0.95rem;
            line-height: 1.7;
            color: var(--text-soft);
            max-height: 250px;
            overflow-y: auto;
        }
        .note-body strong { color: var(--text); }

        /* ===================== MODO EDICI√ìN ===================== */
        .edit-mode-btn {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            display: flex !important;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: all 0.3s;
        }
        .edit-mode-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }
        .edit-mode-btn svg {
            width: 24px;
            height: 24px;
            stroke: white;
            fill: none;
        }
        .edit-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        .edit-modal-content {
            background: var(--bg);
            padding: 30px;
            border-radius: 12px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        .edit-modal h3 {
            margin: 0 0 20px 0;
            color: var(--text);
            font-size: 1.5rem;
        }
        .edit-modal input {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            margin-bottom: 20px;
            background: var(--bg-secondary);
            color: var(--text);
        }
        .edit-modal-buttons {
            display: flex;
            gap: 10px;
        }
        .edit-modal-buttons button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s;
        }
        .edit-modal-buttons .btn-cancel {
            background: var(--bg-secondary);
            color: var(--text-soft);
        }
        .edit-modal-buttons .btn-confirm {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .edit-mode-active #chapterContent p {
            outline: 2px dashed transparent;
            transition: outline 0.2s;
            padding: 5px;
            border-radius: 4px;
        }
        .edit-mode-active #chapterContent p:hover {
            outline-color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }
        .edit-mode-active #mainContent p[contenteditable="true"]:focus {
            outline-color: #764ba2;
            background: rgba(118, 75, 162, 0.1);
        }
        .edit-controls {
            display: none;
            position: fixed;
            top: 80px;
            right: 20px;
            background: var(--bg-card);
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            gap: 10px;
        }
        .edit-controls.active {
            display: flex;
            flex-direction: column;
        }
        .edit-controls button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        .edit-controls .btn-save {
            background: #10b981;
            color: white;
        }
        .edit-controls .btn-export {
            background: #3b82f6;
            color: white;
        }
        .edit-controls .btn-exit {
            background: #ef4444;
            color: white;
        }

        /* ===================== RESPONSIVE ===================== */
        @media(max-width: 600px) {
            #content { font-size: 1.05rem; }
            .theme-picker { display: none; }
            .toolbar { padding: 8px 12px; }
        }
    </style>
</head>
<body>

<!-- BARRA DE PROGRESO GLOBAL -->
<div class="progress-bar-container">
    <div class="progress-bar" id="globalProgress"></div>
</div>

<!-- SIDEBAR -->
<aside id="sidebar">
    <div class="sidebar-head">
        <img src="imagenes/cover_opt.png" alt="El Silencio de los Dioses" class="book-cover" onclick="showMainCover()" title="Ver portada completa" loading="eager" fetchpriority="high" decoding="async">
        <div class="sidebar-title">
            <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"/><path d="M12 6v7"/><path d="m9 9 3 3 3-3"/></svg>
            <h1>El Silencio de los Dioses</h1>
        </div>
    </div>
    <ul class="chapter-list" id="chapterList"></ul>
</aside>

<!-- MAIN -->
<main id="main">
    <header class="toolbar">
        <div class="toolbar-left">
            <button class="btn icon btn-menu" onclick="toggleSidebar()">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg>
            </button>
            <span class="chapter-title" id="chapterTitle">Cargando...</span>
        </div>
        <div class="toolbar-right">
            <div class="theme-picker" id="themePicker">
                <div class="theme-dot active" data-theme="light" title="Claro"></div>
                <div class="theme-dot" data-theme="cream" title="Crema"></div>
                <div class="theme-dot" data-theme="mint" title="Menta"></div>
                <div class="theme-dot" data-theme="ocean" title="Oc√©ano"></div>
                <div class="theme-dot" data-theme="lavender" title="Lavanda"></div>
                <div class="theme-dot" data-theme="sepia" title="Sepia"></div>
                <div class="theme-dot" data-theme="dark" title="Oscuro"></div>
                <div class="theme-dot" data-theme="midnight" title="Medianoche"></div>
            </div>
            <button class="btn icon" onclick="changeFont(-1)" title="Reducir letra">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" x2="16.65" y1="21" y2="16.65"/><line x1="8" x2="14" y1="11" y2="11"/></svg>
            </button>
            <button class="btn icon" onclick="changeFont(1)" title="Aumentar letra">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" x2="16.65" y1="21" y2="16.65"/><line x1="11" x2="11" y1="8" y2="14"/><line x1="8" x2="14" y1="11" y2="11"/></svg>
            </button>
            <button class="btn icon" id="audioToggle" onclick="toggleAudioPlayer()" title="Reproducir audio">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>
            </button>
            <button class="btn icon bookmark-btn" id="bookmarkBtn" onclick="toggleBookmark()" title="Marcar esta p√°gina">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/></svg>
            </button>
        </div>
    </header>

    <section id="reader">
        <div id="loading" class="show">
            <div class="spinner"></div>
            <span style="color: var(--text-soft);">Cargando cap√≠tulo...</span>
        </div>
        <article id="content"></article>
    </section>
</main>

<!-- OVERLAY & NOTE POPUP -->
<div id="overlay" onclick="closeNote()"></div>
<div id="note-popup">
    <div class="note-header">
        <span>
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
            Nota del autor
        </span>
        <button class="note-close" onclick="closeNote()">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
        </button>
    </div>
    <div class="note-body" id="noteBody"></div>
</div>

<script>
// ========== CONFIG ==========
const TOTAL_CHAPTERS = 30;
const FOLDER = 'capitulos_html';
const PREFIX = 'Capitulo ';
const HTML_EXT = '.html';
const JSON_EXT = '_notas.json';

let currentChapter = 1;
let fontSize = 1.15;
let editMode = false;
const EDIT_PASSWORD = '26716975'; // Contrase√±a del modo edici√≥n

// ========== INIT ==========
document.addEventListener('DOMContentLoaded', () => {
    buildChapterList();
    initThemePicker();
    
    // Recuperar preferencias
    const saved = localStorage.getItem('chapter');
    const savedTheme = localStorage.getItem('theme');
    const savedFont = localStorage.getItem('fontSize');
    const firstVisit = localStorage.getItem('firstVisit');
    
    if (saved) currentChapter = parseInt(saved);
    if (savedTheme) setTheme(savedTheme);
    if (savedFont) {
        fontSize = parseFloat(savedFont);
        document.getElementById('content').style.fontSize = fontSize + 'rem';
    }
    
    // Ocultar loading inicial
    document.getElementById('loading').classList.remove('show');
    
    // Detectar primera visita
    if (!firstVisit) {
        // Primera vez: mostrar portada principal
        localStorage.setItem('firstVisit', 'true');
        showMainCover();
    } else {
        // Visitas posteriores: ir directo al √∫ltimo cap√≠tulo sin portada
        if (saved) {
            loadChapterDirectly(parseInt(saved));
        } else {
            showWelcome();
        }
    }
    
    // Actualizar estados de lectura
    updateChapterStates();
    updateProgressBar();
});

// ========== CHAPTERS ==========
const SPECIAL_SECTIONS = {
    'introduccion': { title: 'Introducci√≥n', icon: 'book-open', file: 'secciones/introduccion.html' },
    'sobre-autor': { title: 'Sobre el Autor', icon: 'user', file: 'secciones/sobre-autor.html' },
    'dedicatoria': { title: 'Dedicatoria', icon: 'heart', file: null },
    'agradecimientos': { title: 'Agradecimientos', icon: 'users', file: null },
    'epilogo': { title: 'Ep√≠logo', icon: 'bookmark', file: null }
};

function showMainCover() {
    const coverScreen = document.getElementById('mainCoverScreen');
    coverScreen.classList.add('show');
}

function enterBook() {
    const coverScreen = document.getElementById('mainCoverScreen');
    coverScreen.classList.remove('show');
    showWelcome();
}

function showWelcome() {
    // Mostrar mensaje de bienvenida instant√°neo
    const content = document.getElementById('content');
    content.innerHTML = `
        <div style="text-align: center; padding: 80px 20px; max-width: 600px; margin: 0 auto;">
            <h1 style="font-size: 32px; color: var(--accent); margin-bottom: 20px;">üìö El Silencio de los Dioses</h1>
            <p style="font-size: 20px; line-height: 1.8; color: var(--text-soft); margin-bottom: 40px;">
                Selecciona un cap√≠tulo del √≠ndice para comenzar tu viaje.
            </p>
            <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="opacity: 0.3;">
                <path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"/>
                <path d="M12 6v7"/>
                <path d="m9 9 3 3 3-3"/>
            </svg>
        </div>
    `;
    document.getElementById('chapterTitle').textContent = 'Bienvenido';
    document.getElementById('loading').classList.remove('show');
}

function addSpecialSection(list, key) {
    const section = SPECIAL_SECTIONS[key];
    const li = document.createElement('li');
    li.className = 'chapter-item special-section';
    li.id = 'section-' + key;
    
    const iconPaths = {
        'book-open': 'M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z',
        'user': 'M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2 M12 3a4 4 0 1 0 0 8 4 4 0 0 0 0-8z',
        'heart': 'M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z',
        'users': 'M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2 M9 3a4 4 0 1 0 0 8 4 4 0 0 0 0-8z M23 21v-2a4 4 0 0 0-3-3.87 M16 3.13a4 4 0 0 1 0 7.75',
        'bookmark': 'M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z'
    };
    
    li.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="${iconPaths[section.icon]}"/></svg>
        ${section.title}
    `;
    
    li.onclick = () => {
        loadSpecialSection(key);
        if (window.innerWidth < 900) toggleSidebar();
    };
    
    list.appendChild(li);
}

function loadSpecialSection(key) {
    const section = SPECIAL_SECTIONS[key];
    if (!section.file) return;
    
    const content = document.getElementById('content');
    const loading = document.getElementById('loading');
    
    loading.classList.add('show');
    
    fetch(section.file)
        .then(r => r.text())
        .then(html => {
            content.innerHTML = html;
            loading.classList.remove('show');
            document.getElementById('reader').scrollTop = 0;
            document.getElementById('chapterTitle').textContent = section.title;
        })
        .catch(err => {
            console.error('Error cargando secci√≥n:', err);
            loading.classList.remove('show');
        });
}

function buildChapterList() {
    const list = document.getElementById('chapterList');
    
    // Secciones iniciales (antes de los cap√≠tulos)
    const initialSections = ['introduccion', 'sobre-autor', 'dedicatoria'];
    if (initialSections.some(key => SPECIAL_SECTIONS[key].file)) {
        const divider = document.createElement('div');
        divider.className = 'chapter-list-divider';
        divider.textContent = '‚Äî Preliminares ‚Äî';
        list.appendChild(divider);
        
        initialSections.forEach(key => {
            if (SPECIAL_SECTIONS[key].file) {
                addSpecialSection(list, key);
            }
        });
    }
    
    // Cap√≠tulos
    const chapDivider = document.createElement('div');
    chapDivider.className = 'chapter-list-divider';
    chapDivider.textContent = '‚Äî Cap√≠tulos ‚Äî';
    list.appendChild(chapDivider);
    
    for (let i = 1; i <= TOTAL_CHAPTERS; i++) {
        const li = document.createElement('li');
        li.className = 'chapter-item';
        li.id = 'ch-' + i;
        
        const chapterNum = i.toString().padStart(2, '0');
        const hasImage = i <= 30;
        
        // Las primeras 10 miniaturas con carga eager para instantaneidad
        const loadingAttr = i <= 10 ? 'eager' : 'lazy';
        const priorityAttr = i <= 10 ? 'high' : 'low';
        
        if (hasImage) {
            li.innerHTML = `
                <img src="imagenes/cap_${chapterNum}.png" alt="Cap√≠tulo ${chapterNum}" class="chapter-thumbnail" width="36" height="36" loading="${loadingAttr}" decoding="async" fetchpriority="${priorityAttr}">
                Cap√≠tulo ${chapterNum}
            `;
        } else {
            li.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 6v12a3 3 0 1 0 3-3H6a3 3 0 1 0 3 3V6a3 3 0 1 0-3 3h12a3 3 0 1 0-3-3"/></svg>
                Cap√≠tulo ${chapterNum}
            `;
        }
        
        li.onclick = () => {
            loadChapter(i);
            if (window.innerWidth < 900) toggleSidebar();
        };
        list.appendChild(li);
    }
    
    // Secciones finales (despu√©s de los cap√≠tulos)
    const finalSections = ['agradecimientos', 'epilogo'];
    if (finalSections.some(key => SPECIAL_SECTIONS[key].file)) {
        const divider = document.createElement('div');
        divider.className = 'chapter-list-divider';
        divider.textContent = '‚Äî Extras ‚Äî';
        list.appendChild(divider);
        
        finalSections.forEach(key => {
            if (SPECIAL_SECTIONS[key].file) {
                addSpecialSection(list, key);
            }
        });
    }
}

function addSpecialSection(list, key) {
    const section = SPECIAL_SECTIONS[key];
    const li = document.createElement('li');
    li.className = 'chapter-item special-section';
    li.id = 'section-' + key;
    
    const iconPaths = {
        'book-open': 'M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z',
        'user': 'M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2 M12 3a4 4 0 1 0 0 8 4 4 0 0 0 0-8z',
        'heart': 'M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z',
        'users': 'M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2 M9 3a4 4 0 1 0 0 8 4 4 0 0 0 0-8z M23 21v-2a4 4 0 0 0-3-3.87 M16 3.13a4 4 0 0 1 0 7.75',
        'bookmark': 'M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z'
    };
    
    li.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="${iconPaths[section.icon]}"/></svg>
        ${section.title}
    `;
    
    li.onclick = () => {
        loadSpecialSection(key);
        if (window.innerWidth < 900) toggleSidebar();
    };
    
    list.appendChild(li);
}

function loadSpecialSection(key) {
    const section = SPECIAL_SECTIONS[key];
    if (!section.file) return;
    
    const content = document.getElementById('content');
    const loading = document.getElementById('loading');
    
    loading.classList.add('show');
    
    fetch(section.file)
        .then(r => r.text())
        .then(html => {
            content.innerHTML = html;
            loading.classList.remove('show');
            document.getElementById('reader').scrollTop = 0;
            document.getElementById('chapterTitle').textContent = section.title;
        })
        .catch(err => {
            console.error('Error cargando secci√≥n:', err);
            loading.classList.remove('show');
        });
}

async function loadChapter(n) {
    currentChapter = n;
    localStorage.setItem('chapter', n);
    highlightChapter(n);
    
    // Mostrar pantalla de portada primero
    showCoverScreen(n);
}

async function loadChapterDirectly(n) {
    // Cargar cap√≠tulo sin mostrar portada (para restaurar sesi√≥n)
    currentChapter = n;
    localStorage.setItem('chapter', n);
    highlightChapter(n);
    
    const content = document.getElementById('content');
    const loading = document.getElementById('loading');
    
    const num = n.toString().padStart(2, '0');
    document.getElementById('chapterTitle').textContent = 'Cap√≠tulo ' + num;
    
    const htmlFile = FOLDER + '/' + PREFIX + num + HTML_EXT;
    const jsonFile = FOLDER + '/' + PREFIX + num + JSON_EXT;
    
    try {
        const htmlRes = await fetch(htmlFile);
        if (!htmlRes.ok) throw new Error('HTML no encontrado');
        
        const html = await htmlRes.text();
        content.innerHTML = html;
        loading.classList.remove('show');
        
        // Cargar notas en segundo plano sin bloquear
        fetch(jsonFile)
            .then(r => r.ok ? r.json() : null)
            .then(notes => notes && setupNotesWithJSON(notes))
            .catch(() => {});
        
        addNavButtons(n);
        updateBookmarkButton();
        markChapterAsReading(n);
        
    } catch (e) {
        console.error('‚ùå Error cargando cap√≠tulo:', e);
        loading.classList.remove('show');
    }
}

function showCoverScreen(n) {
    const num = n.toString().padStart(2, '0');
    const coverScreen = document.getElementById('coverScreen');
    const coverImg = document.getElementById('coverImageFull');
    const chapterTitle = document.getElementById('coverChapterTitle');
    
    // Configurar portada
    chapterTitle.textContent = `Cap√≠tulo ${num}`;
    
    // Optimizar carga de imagen: solo cambiar si es necesario
    const newSrc = n <= 30 ? `imagenes/cap_${num}.png` : `imagenes/cover_opt.png`;
    if (!coverImg.src.endsWith(newSrc.split('/').pop())) {
        coverImg.src = newSrc;
    }
    
    // Mostrar pantalla de portada
    coverScreen.classList.add('show');
}

async function startReading() {
    const coverScreen = document.getElementById('coverScreen');
    coverScreen.classList.remove('show');
    
    const n = currentChapter;
    const content = document.getElementById('content');
    const loading = document.getElementById('loading');
    
    loading.classList.add('show');
    content.innerHTML = '';
    
    const num = n.toString().padStart(2, '0');
    document.getElementById('chapterTitle').textContent = 'Cap√≠tulo ' + num;
    
    const htmlFile = FOLDER + '/' + PREFIX + num + HTML_EXT;
    const jsonFile = FOLDER + '/' + PREFIX + num + JSON_EXT;
    
    try {
        // Cargar HTML del cap√≠tulo
        const htmlRes = await fetch(htmlFile);
        if (!htmlRes.ok) throw new Error('HTML no encontrado');
        
        const html = await htmlRes.text();
        content.innerHTML = html;
        loading.classList.remove('show');
        document.getElementById('reader').scrollTop = 0;
        
        // Cargar notas en segundo plano sin bloquear
        fetch(jsonFile)
            .then(r => r.ok ? r.json() : null)
            .then(notes => notes && setupNotesWithJSON(notes))
            .catch(() => {});
        
        addNavButtons(n);
        updateBookmarkButton();
        markChapterAsReading(n);
        
    } catch (e) {
        console.error('Error cargando cap√≠tulo:', e);
        loading.classList.remove('show');
        content.innerHTML = `
            <div style="text-align:center; padding:60px 20px;">
                <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="margin-bottom:20px;"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"/></svg>
                <h2 style="font-family:var(--font-ui); margin-bottom:8px;">Cap√≠tulo ${num} no disponible</h2>
                <p style="color:var(--text-soft); font-family:var(--font-ui);">Este cap√≠tulo a√∫n no ha sido publicado.</p>
            </div>
        `;
        addNavButtons(n);
    }
}

function highlightChapter(n) {
    document.querySelectorAll('.chapter-item').forEach(el => el.classList.remove('active'));
    const el = document.getElementById('ch-' + n);
    if (el) {
        el.classList.add('active');
        el.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
}

// ========== BOOKMARKS & PROGRESS ==========
function toggleBookmark() {
    const bookmarks = getBookmarks();
    const key = `ch-${currentChapter}`;
    const scrollPos = document.getElementById('reader').scrollTop;
    
    if (bookmarks[key]) {
        delete bookmarks[key];
        showToast('Marcador eliminado');
    } else {
        bookmarks[key] = {
            chapter: currentChapter,
            scroll: scrollPos,
            date: new Date().toISOString()
        };
        showToast('‚úì Marcador guardado');
    }
    
    localStorage.setItem('bookmarks', JSON.stringify(bookmarks));
    updateBookmarkButton();
    updateChapterStates();
}

function getBookmarks() {
    const saved = localStorage.getItem('bookmarks');
    return saved ? JSON.parse(saved) : {};
}

function updateBookmarkButton() {
    const btn = document.getElementById('bookmarkBtn');
    if (!btn) return;
    
    const bookmarks = getBookmarks();
    const key = `ch-${currentChapter}`;
    
    if (bookmarks[key]) {
        btn.classList.add('active');
    } else {
        btn.classList.remove('active');
    }
}

function markChapterAsReading(n) {
    // Ejecutar en segundo plano para no bloquear
    setTimeout(() => {
        const readChapters = getReadChapters();
        readChapters[`ch-${n}`] = 'reading';
        localStorage.setItem('readChapters', JSON.stringify(readChapters));
        updateChapterStates();
        updateProgressBar();
    }, 50);
}

function markChapterAsRead(n) {
    const readChapters = getReadChapters();
    if (readChapters[`ch-${n}`] === 'read') return; // Ya est√° marcado
    readChapters[`ch-${n}`] = 'read';
    localStorage.setItem('readChapters', JSON.stringify(readChapters));
    updateChapterStates();
    updateProgressBar();
}

function getReadChapters() {
    const saved = localStorage.getItem('readChapters');
    return saved ? JSON.parse(saved) : {};
}

function updateChapterStates() {
    const readChapters = getReadChapters();
    const bookmarks = getBookmarks();
    
    for (let i = 1; i <= TOTAL_CHAPTERS; i++) {
        const el = document.getElementById('ch-' + i);
        if (!el) continue;
        
        el.classList.remove('read', 'reading', 'bookmarked');
        
        const key = `ch-${i}`;
        if (readChapters[key] === 'read') el.classList.add('read');
        if (readChapters[key] === 'reading') el.classList.add('reading');
        if (bookmarks[key]) el.classList.add('bookmarked');
    }
}

function updateProgressBar() {
    const readChapters = getReadChapters();
    const totalRead = Object.values(readChapters).filter(v => v === 'read').length;
    const percentage = (totalRead / TOTAL_CHAPTERS) * 100;
    
    const progressBar = document.getElementById('globalProgress');
    if (progressBar) {
        progressBar.style.width = percentage + '%';
    }
}

function saveScrollPosition() {
    if (currentChapter) {
        const scrollPos = document.getElementById('reader').scrollTop;
        localStorage.setItem('scrollPosition', scrollPos);
        
        // Si lleg√≥ al final del cap√≠tulo, marcarlo como le√≠do
        const reader = document.getElementById('reader');
        const scrollPercentage = (reader.scrollTop + reader.clientHeight) / reader.scrollHeight;
        if (scrollPercentage > 0.95) {
            markChapterAsRead(currentChapter);
        }
    }
}

function showToast(message) {
    const toast = document.createElement('div');
    toast.style.cssText = `
        position: fixed;
        bottom: 120px;
        left: 50%;
        transform: translateX(-50%);
        background: var(--text);
        color: var(--bg);
        padding: 12px 24px;
        border-radius: 50px;
        font-size: 14px;
        font-weight: 500;
        z-index: 10000;
        animation: fadeIn 0.3s ease;
    `;
    toast.textContent = message;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.animation = 'fadeOut 0.3s ease';
        setTimeout(() => toast.remove(), 300);
    }, 2000);
}

function addNavButtons(n) {
    const nav = document.createElement('div');
    nav.className = 'nav-chapter';
    
    const prev = n > 1 ? n - 1 : null;
    const next = n < TOTAL_CHAPTERS ? n + 1 : null;
    
    nav.innerHTML = `
        <button class="nav-btn" onclick="loadChapter(${prev})" ${!prev ? 'disabled' : ''}>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
            Anterior
        </button>
        <button class="nav-btn" onclick="loadChapter(${next})" ${!next ? 'disabled' : ''}>
            Siguiente
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>
        </button>
    `;
    document.getElementById('content').appendChild(nav);
}

// ========== NOTAS AL PIE ==========
function setupNotesWithJSON(notesData) {
    const content = document.getElementById('content');
    if (!content) return;
    
    // Buscar todos los SUP en el contenido
    const allSups = content.querySelectorAll('sup');
    
    allSups.forEach((sup) => {
        const text = sup.textContent.trim();
        const numMatch = text.match(/\((\d+)\)/);
        
        if (numMatch) {
            const noteNum = numMatch[1];
            
            // Verificar si existe nota para este n√∫mero
            if (notesData[noteNum]) {
                sup.style.cursor = 'pointer';
                sup.style.color = 'var(--accent)';
                sup.style.textDecoration = 'none';
                sup.style.borderBottom = '1px dotted var(--accent)';
                sup.title = `Ver nota ${noteNum}`;
                
                sup.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const noteHTML = notesData[noteNum];
                    showNote(noteHTML);
                });
            }
        }
    });
}

function showNote(html) {
    document.getElementById('noteBody').innerHTML = html;
    document.getElementById('overlay').classList.add('show');
    document.getElementById('note-popup').classList.add('show');
}

function closeNote() {
    document.getElementById('overlay').classList.remove('show');
    document.getElementById('note-popup').classList.remove('show');
}

// ========== TEMAS ==========
function initThemePicker() {
    document.querySelectorAll('.theme-dot').forEach(dot => {
        dot.onclick = () => setTheme(dot.dataset.theme);
    });
}

function setTheme(t) {
    document.body.setAttribute('data-theme', t === 'light' ? '' : t);
    document.querySelectorAll('.theme-dot').forEach(d => d.classList.remove('active'));
    document.querySelector(`.theme-dot[data-theme="${t}"]`)?.classList.add('active');
    localStorage.setItem('theme', t);
}

// ========== FONT ==========
function changeFont(delta) {
    fontSize = Math.max(0.9, Math.min(1.6, fontSize + delta * 0.1));
    document.getElementById('content').style.fontSize = fontSize + 'rem';
    localStorage.setItem('fontSize', fontSize);
}

// ========== SIDEBAR ==========
function toggleSidebar() {
    document.getElementById('sidebar').classList.toggle('open');
}

// Cerrar sidebar al click fuera (m√≥vil)
document.addEventListener('click', (e) => {
    const sidebar = document.getElementById('sidebar');
    if (window.innerWidth < 900 && sidebar.classList.contains('open')) {
        if (!sidebar.contains(e.target) && !e.target.closest('.btn-menu')) {
            sidebar.classList.remove('open');
        }
    }
});

// Teclas
document.addEventListener('keydown', (e) => {
    if (e.key === 'ArrowLeft' && currentChapter > 1) loadChapter(currentChapter - 1);
    if (e.key === 'ArrowRight' && currentChapter < TOTAL_CHAPTERS) loadChapter(currentChapter + 1);
    if (e.key === 'Escape') closeNote();
    if (e.key === ' ' && audioPlayer.classList.contains('show')) {
        e.preventDefault();
        togglePlayPause();
    }
});

// ========== AUDIO PLAYER ==========
let speechSynthesis = window.speechSynthesis;
let currentUtterance = null;
let isPaused = false;
let isReading = false;
let currentTextIndex = 0;
let textChunks = [];
let speechRate = 1.0; // Velocidad de lectura (0.5 - 2.0)

function toggleAudioPlayer() {
    const player = document.getElementById('audioPlayer');
    const isVisible = player.classList.contains('show');
    
    if (isVisible) {
        closeAudioPlayer();
    } else {
        openAudioPlayer();
    }
}

function openAudioPlayer() {
    const player = document.getElementById('audioPlayer');
    
    // Preparar texto del cap√≠tulo actual
    prepareTextForReading();
    
    player.classList.add('show');
    updateAudioInfo();
}

function closeAudioPlayer() {
    const player = document.getElementById('audioPlayer');
    stopReading();
    player.classList.remove('show');
}

function prepareTextForReading() {
    const content = document.getElementById('content');
    if (!content) return;
    
    // Extraer todo el texto visible del cap√≠tulo
    const paragraphs = content.querySelectorAll('p, h1, h2, h3');
    textChunks = [];
    
    paragraphs.forEach(p => {
        const text = p.textContent.trim();
        if (text && !text.startsWith('NOTAS DE AUTOR')) {
            // Dividir p√°rrafos largos en chunks m√°s peque√±os
            if (text.length > 500) {
                const sentences = text.match(/[^.!?]+[.!?]+/g) || [text];
                textChunks.push(...sentences);
            } else {
                textChunks.push(text);
            }
        }
    });
    
    currentTextIndex = 0;
}

function updateAudioInfo() {
    const num = currentChapter.toString().padStart(2, '0');
    document.getElementById('audioChapterTitle').textContent = `Cap√≠tulo ${num}`;
    
    // Actualizar portada solo si es necesario (lazy load)
    const coverImg = document.getElementById('audioCover');
    const newSrc = currentChapter <= 30 ? `imagenes/cap_${num}.png` : `imagenes/cover_opt.png`;
    
    // Solo cambiar si es diferente para evitar recargas innecesarias
    if (coverImg.src !== newSrc && !coverImg.src.endsWith(newSrc)) {
        coverImg.src = newSrc;
    }
}

function togglePlayPause() {
    if (isReading && !isPaused) {
        pauseAudio();
    } else {
        playAudio();
    }
}

function playAudio() {
    if (textChunks.length === 0) {
        prepareTextForReading();
    }
    
    if (isPaused) {
        // Reanudar
        speechSynthesis.resume();
        isPaused = false;
    } else {
        // Iniciar desde el √≠ndice actual
        isReading = true;
        readNextChunk();
    }
    
    updatePlayButton(true);
}

function pauseAudio() {
    if (speechSynthesis.speaking) {
        speechSynthesis.pause();
        isPaused = true;
        updatePlayButton(false);
    }
}

function stopReading() {
    speechSynthesis.cancel();
    currentUtterance = null;
    isReading = false;
    isPaused = false;
    currentTextIndex = 0;
    updatePlayButton(false);
    updateProgress(0);
}

function readNextChunk() {
    if (currentTextIndex >= textChunks.length) {
        // Termin√≥ el cap√≠tulo
        if (currentChapter < TOTAL_CHAPTERS) {
            // Auto-avanzar al siguiente cap√≠tulo
            loadChapter(currentChapter + 1);
            setTimeout(() => {
                prepareTextForReading();
                currentTextIndex = 0;
                readNextChunk();
            }, 500);
        } else {
            stopReading();
        }
        return;
    }
    
    const text = textChunks[currentTextIndex];
    currentUtterance = new SpeechSynthesisUtterance(text);
    
    // Configurar voz en espa√±ol si est√° disponible
    const voices = speechSynthesis.getVoices();
    const spanishVoice = voices.find(voice => 
        voice.lang.startsWith('es') || voice.lang.startsWith('spa')
    );
    if (spanishVoice) {
        currentUtterance.voice = spanishVoice;
    }
    
    currentUtterance.lang = 'es-ES';
    currentUtterance.rate = speechRate; // Velocidad de lectura ajustable
    currentUtterance.pitch = 1.0;
    currentUtterance.volume = 1.0;
    
    currentUtterance.onend = () => {
        currentTextIndex++;
        updateProgress((currentTextIndex / textChunks.length) * 100);
        
        if (isReading && !isPaused) {
            readNextChunk();
        }
    };
    
    currentUtterance.onerror = (e) => {
        console.error('Error en s√≠ntesis de voz:', e);
        stopReading();
    };
    
    speechSynthesis.speak(currentUtterance);
    updateProgress((currentTextIndex / textChunks.length) * 100);
}

function skipBackward() {
    if (currentTextIndex > 0) {
        currentTextIndex = Math.max(0, currentTextIndex - 3);
        speechSynthesis.cancel();
        if (isReading) {
            readNextChunk();
        }
    }
}

function skipForward() {
    if (currentTextIndex < textChunks.length - 1) {
        currentTextIndex = Math.min(textChunks.length - 1, currentTextIndex + 3);
        speechSynthesis.cancel();
        if (isReading) {
            readNextChunk();
        }
    }
}

function setAudioProgress(e) {
    const progressBar = document.getElementById('audioProgress');
    const rect = progressBar.getBoundingClientRect();
    const percent = (e.clientX - rect.left) / rect.width;
    
    currentTextIndex = Math.floor(percent * textChunks.length);
    speechSynthesis.cancel();
    
    if (isReading) {
        readNextChunk();
    }
    
    updateProgress(percent * 100);
}

function updateProgress(percent) {
    document.getElementById('audioProgressBar').style.width = percent + '%';
    
    // Calcular tiempo estimado basado en chunks
    const totalChunks = textChunks.length;
    const avgTimePerChunk = 5; // ~5 segundos por chunk (estimado)
    const totalSeconds = totalChunks * avgTimePerChunk;
    const currentSeconds = currentTextIndex * avgTimePerChunk;
    
    document.getElementById('audioCurrentTime').textContent = formatTime(currentSeconds);
    document.getElementById('audioDuration').textContent = formatTime(totalSeconds);
}

function setVolume(e) {
    // La Web Speech API no soporta cambio de volumen en tiempo real
    // pero podemos guardarlo para la pr√≥xima utterance
    const volume = e.target.value / 100;
    if (currentUtterance) {
        currentUtterance.volume = volume;
    }
}

function setSpeechRate(e) {
    speechRate = parseFloat(e.target.value);
    document.getElementById('speedValue').textContent = speechRate.toFixed(1) + 'x';
    
    // Si est√° leyendo, reiniciar el chunk actual con la nueva velocidad
    if (isReading && !isPaused) {
        speechSynthesis.cancel();
        readNextChunk();
    }
}

function updatePlayButton(playing) {
    const icon = playing ? `
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="4" height="16" x="6" y="4"/><rect width="4" height="16" x="14" y="4"/></svg>
    ` : `
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"/></svg>
    `;
    document.getElementById('playIcon').innerHTML = icon;
}

function formatTime(seconds) {
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${mins}:${secs.toString().padStart(2, '0')}`;
}

// Cargar voces cuando est√©n disponibles
if (speechSynthesis.onvoiceschanged !== undefined) {
    speechSynthesis.onvoiceschanged = () => {
        // Voces cargadas
    };
}

// Actualizar info cuando cambia el cap√≠tulo
const originalLoadChapter = loadChapter;
loadChapter = function(n) {
    originalLoadChapter(n);
    
    // Detener lectura si est√° activa
    if (isReading) {
        stopReading();
    }
    
    // Actualizar info del reproductor si est√° visible
    const player = document.getElementById('audioPlayer');
    if (player.classList.contains('show')) {
        setTimeout(() => {
            prepareTextForReading();
            updateAudioInfo();
        }, 100);
    }
};
</script>

<!-- PORTADA PRINCIPAL -->
<div class="cover-screen main-cover-screen" id="mainCoverScreen">
    <div class="cover-image-container">
        <img src="imagenes/cover_opt.png" alt="Portada" class="cover-image-full" loading="eager" decoding="async" fetchpriority="high">
    </div>
    <h1 class="cover-book-title">El Silencio de los Dioses</h1>
    <p class="cover-author">Por Aldo Wagner</p>
    <button class="enter-book-btn" onclick="enterBook()">üìñ Entrar al Libro</button>
</div>

<!-- PANTALLA DE PORTADA DE CAP√çTULO -->
<div class="cover-screen" id="coverScreen">
    <div class="cover-image-container">
        <img id="coverImageFull" src="imagenes/cover_opt.png" alt="Portada" class="cover-image-full" loading="lazy" decoding="async">
    </div>
    <h1 class="cover-chapter-title" id="coverChapterTitle">Cap√≠tulo 01</h1>
    <p class="cover-book-title">El Silencio de los Dioses</p>
    <button class="start-reading-btn" onclick="startReading()">‚ú® Comenzar a Leer</button>
</div>

<!-- REPRODUCTOR DE AUDIO -->
<div class="audio-player" id="audioPlayer">
    <div class="audio-info">
        <img id="audioCover" src="imagenes/cover_opt.png" alt="Portada" class="audio-cover" loading="eager" decoding="async" fetchpriority="high">
        <div class="audio-details">
            <div class="audio-title" id="audioChapterTitle">Cap√≠tulo 01</div>
            <div class="audio-subtitle">Narraci√≥n por voz sint√©tica</div>
        </div>
    </div>
    
    <div class="audio-controls">
        <button class="audio-btn secondary" onclick="skipBackward()" title="Retroceder p√°rrafos">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 2v6h6"/><path d="M21 12A9 9 0 0 0 6 5.3L3 8"/></svg>
        </button>
        
        <button class="audio-btn" onclick="togglePlayPause()" title="Reproducir/Pausar">
            <span id="playIcon">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"/></svg>
            </span>
        </button>
        
        <button class="audio-btn secondary" onclick="skipForward()" title="Avanzar p√°rrafos">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 2v6h-6"/><path d="M3 12a9 9 0 0 1 15-6.7L21 8"/></svg>
        </button>
    </div>
    
    <div class="audio-progress-container">
        <div class="audio-times">
            <span id="audioCurrentTime">0:00</span>
            <span id="audioDuration">0:00</span>
        </div>
        <div class="audio-progress" id="audioProgress" onclick="setAudioProgress(event)">
            <div class="audio-progress-bar" id="audioProgressBar"></div>
        </div>
    </div>
    
    <div class="audio-volume">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/></svg>
        <input type="range" class="volume-slider" min="0" max="100" value="100" oninput="setVolume(event)">
    </div>
    
    <div class="audio-speed">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
        <input type="range" class="speed-slider" min="0.5" max="2.0" step="0.1" value="1.0" oninput="setSpeechRate(event)">
        <span id="speedValue" class="speed-value">1.0x</span>
    </div>
    
    <button class="audio-close" onclick="closeAudioPlayer()" title="Cerrar reproductor">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
    </button>
</div>

<!-- Modo Edici√≥n -->
<button class="edit-mode-btn" onclick="showEditModal()" title="Modo Edici√≥n">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
    </svg>
</button>

<div class="edit-modal" id="editModal">
    <div class="edit-modal-content">
        <h3>üîê Modo Edici√≥n</h3>
        <p style="margin-bottom:15px; color: var(--text-soft);">Ingresa la contrase√±a para editar el libro:</p>
        <input type="password" id="editPassword" placeholder="Contrase√±a">
        <div class="edit-modal-buttons">
            <button class="btn-cancel" onclick="closeEditModal()">Cancelar</button>
            <button class="btn-confirm" onclick="activateEditMode()">Activar</button>
        </div>
    </div>
</div>

<div class="edit-controls" id="editControls">
    <button class="btn-save" onclick="saveEdits()">üíæ Guardar Cambios</button>
    <button class="btn-export" onclick="exportEdits()">üì• Exportar Cambios</button>
    <button class="btn-exit" onclick="exitEditMode()">‚ùå Salir</button>
</div>

<script>
// ========== MODO EDICI√ìN ==========
function showEditModal() {
    document.getElementById('editModal').style.display = 'flex';
    document.getElementById('editPassword').value = '';
    document.getElementById('editPassword').focus();
}

function closeEditModal() {
    document.getElementById('editModal').style.display = 'none';
}

function activateEditMode() {
    const password = document.getElementById('editPassword').value;
    if (password === EDIT_PASSWORD) {
        editMode = true;
        document.body.classList.add('edit-mode-active');
        document.getElementById('editControls').classList.add('active');
        makeContentEditable();
        closeEditModal();
        loadSavedEdits();
        alert('‚úÖ Modo edici√≥n activado. Haz clic en cualquier p√°rrafo para editarlo.');
    } else {
        alert('‚ùå Contrase√±a incorrecta');
        document.getElementById('editPassword').value = '';
    }
}

function makeContentEditable() {
    const paragraphs = document.querySelectorAll('#mainContent p');
    paragraphs.forEach((p, index) => {
        p.setAttribute('contenteditable', 'true');
        p.setAttribute('data-index', index);
        p.addEventListener('input', () => markAsEdited(p));
    });
}

function markAsEdited(element) {
    element.style.borderLeft = '3px solid #10b981';
}

function saveEdits() {
    const edits = {};
    const paragraphs = document.querySelectorAll('#mainContent p[contenteditable="true"]');
    
    paragraphs.forEach((p) => {
        const index = p.getAttribute('data-index');
        edits[`cap${currentChapter}_p${index}`] = p.innerHTML;
    });
    
    localStorage.setItem('bookEdits', JSON.stringify(edits));
    alert('‚úÖ Cambios guardados localmente');
}

function loadSavedEdits() {
    const saved = localStorage.getItem('bookEdits');
    if (!saved) return;
    
    const edits = JSON.parse(saved);
    const paragraphs = document.querySelectorAll('#mainContent p[contenteditable="true"]');
    
    paragraphs.forEach((p) => {
        const index = p.getAttribute('data-index');
        const key = `cap${currentChapter}_p${index}`;
        if (edits[key]) {
            p.innerHTML = edits[key];
            markAsEdited(p);
        }
    });
}

function exportEdits() {
    const saved = localStorage.getItem('bookEdits');
    if (!saved) {
        alert('No hay cambios para exportar');
        return;
    }
    
    const edits = JSON.parse(saved);
    const blob = new Blob([JSON.stringify(edits, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `ediciones_libro_${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
    
    alert('‚úÖ Archivo de cambios descargado. Env√≠amelo para aplicar las correcciones.');
}

function exitEditMode() {
    if (confirm('¬øSalir del modo edici√≥n? Los cambios guardados se mantendr√°n.')) {
        editMode = false;
        document.body.classList.remove('edit-mode-active');
        document.getElementById('editControls').classList.remove('active');
        
        const paragraphs = document.querySelectorAll('#chapterContent p');
        paragraphs.forEach(p => {
            p.setAttribute('contenteditable', 'false');
            p.style.borderLeft = '';
        });
    }
}

// Permitir Enter en el modal de contrase√±a
document.getElementById('editPassword')?.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') activateEditMode();
});
</script>

</body>
</html>

